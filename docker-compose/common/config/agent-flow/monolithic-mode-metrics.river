// https://github.com/grafana/agent-configurator

logging {
  level  = "warn"
  format = "logfmt"
}

module.file "docker_compose" {
	  filename = env("AGENT_CONFIG_FOLDER") + "/modules/docker_compose.river"
    arguments {
      metrics_endpoint  = "http://mimir:8080"
    }
}

discovery.dns "dns_lookup_mimir" {
  names = ["mimir"]
  type = "A"
  port = 8080
  refresh_interval= "60s"
}

/********************************************
 * Metrics
 ********************************************/

prometheus.exporter.unix {
  set_collectors     = ["cpu"]
  disable_collectors = ["diskstats", "mdadm", "textfile", "hwmon"]
}

prometheus.scrape "integrations" {
  targets    = concat(
    [{"__address__" = "agent:12345",  "job" = "monitoring/agent"}],
    [{"__address__" = "grafana:3000", "job" = "monitoring/grafana"}],
    prometheus.exporter.unix.targets,
  )
  scrape_interval = "15s"
  
  clustering { enabled = true }
  
  forward_to = [prometheus.relabel.integrations.receiver]
}

prometheus.scrape "dns_lookup_mimir" {
  targets  = discovery.dns.dns_lookup_mimir.targets
  scrape_interval = "15s"
  job_name = "monitoring/mimir"
  
  clustering { enabled = true }
  
  forward_to = [prometheus.relabel.integrations.receiver]
}

prometheus.scrape "minio" {
  targets = [{"__address__" = "minio:9000", "job" = "integrations/minio"}]
  
  scrape_interval = "15s"
  metrics_path    = "/minio/v2/metrics/cluster"

  forward_to = [prometheus.relabel.integrations.receiver]
}

prometheus.relabel "integrations" {
  rule {
		source_labels = ["__address__"]
		target_label  = "scraped_by"
    replacement   = "grafana-agent"
	}

  rule {
		source_labels = ["__address__"]
		target_label  = "cluster"
    replacement   = "docker-compose"
	}

  rule {
		source_labels = ["__address__"]
		target_label  = "namespace"
    replacement   = "monitoring"
	}

  rule {
		source_labels = ["job"]
    regex         = "(integrations|monitoring)/(.*)"
		target_label  = "pod"
    replacement   = "${2}"
	}

  rule {
		source_labels = ["job"]
    regex         = "(integrations|monitoring)/(.*)"
		target_label  = "container"
    replacement   = "${2}"
	}

  forward_to = [module.file.docker_compose.exports.metrics_receiver]
}

/********************************************
 * Otelcol for metrics
 ********************************************/

otelcol.receiver.otlp "containers" {
	grpc { endpoint = "0.0.0.0:4317" }
	http { endpoint = "0.0.0.0:4318" }

	output {
		metrics = [otelcol.processor.batch.containers.input]
	}
}

otelcol.processor.batch "containers" {
	output {
        metrics = [otelcol.processor.memory_limiter.containers.input]
    }
}

otelcol.processor.memory_limiter "containers" {
  check_interval = "1s"
  limit 		     = "256MiB"

	output {
    metrics = [otelcol.exporter.prometheus.containers.input]
  }
}

otelcol.exporter.prometheus "containers" { 
  forward_to = [module.file.docker_compose.exports.metrics_receiver] 
}